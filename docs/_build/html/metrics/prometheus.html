
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Prometheus Integration with Metrics Exporter &#8212; Network Operator</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=643846e8" />
    <link rel="stylesheet" type="text/css" href="../_static/rocm_header.css?v=9557e3d1" />
    <link rel="stylesheet" type="text/css" href="../_static/rocm_footer.css?v=7095035a" />
    <link rel="stylesheet" type="text/css" href="../_static/fonts.css?v=fcff5274" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=a1637f0b"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script async="async" src="../_static/code_word_breaks.js?v=327952c4"></script>
    <script async="async" src="../_static/renameVersionLinks.js?v=929fe5e4"></script>
    <script async="async" src="../_static/rdcMisc.js?v=01f88d96"></script>
    <script async="async" src="../_static/theme_mode_captions.js?v=15f4ec5d"></script>
    <script defer="defer" src="../_static/search.js?v=90a4452c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'metrics/prometheus';</script>
    <script async="async" src="https://download.amd.com/js/analytics/analyticsinit.js"></script>
    <link rel="canonical" href="instinct.docs.amd.com/metrics/prometheus.html" />
    <link rel="icon" href="https://www.amd.com/content/dam/code/images/favicon/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="google-site-verification" content="vo35SZt_GASsTHAEmdww7AYKPCvZyzLvOXBl8guBME4" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  

<header class="common-header" >
    <nav class="navbar navbar-expand-xl">
        <div class="container-fluid main-nav rocm-header">
            
            <button class="navbar-toggler collapsed" id="nav-icon" data-tracking-information="mainMenuToggle" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
            
            <div class="header-logo">
                <a class="navbar-brand" href="https://www.amd.com/">
                    <img src="../_static/images/amd-header-logo.svg" alt="AMD Logo" title="AMD Logo" width="90" class="d-inline-block align-text-top hover-opacity"/>
                </a>
                <div class="vr vr mx-40 my-25"></div>
                
        
    
    <a class="klavika-font hover-opacity" href="https://instinct.docs.amd.com">Instinct&#8482; Documentation</a>
                
            </div>
            <div class="icon-nav text-center d-flex ms-auto">
            </div>
        </div>
    </nav>
    
    <nav class="navbar navbar-expand-xl second-level-nav">
        <div class="container-fluid main-nav">
            <div class="navbar-nav-container collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav nav-mega me-auto mb-2 mb-lg-0 col-xl-10">
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="http://github.com/ROCm/network-operator" id="navgithub" role="button" aria-expanded="false" target="_blank" >
                                GitHub
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="https://github.com/ROCm/ROCm/discussions" id="navcommunity" role="button" aria-expanded="false" target="_blank" >
                                Community
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="https://rocm.blogs.amd.com/" id="navblogs" role="button" aria-expanded="false" target="_blank" >
                                Blogs
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="https://www.amd.com/en/developer/resources/rocm-hub.html" id="navrocm-developer-hub" role="button" aria-expanded="false" target="_blank" >
                                ROCm Developer Hub
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="https://rocm.docs.amd.com" id="navrocm&#8482;-docs" role="button" aria-expanded="false" target="_blank" >
                                ROCm&#8482; Docs
                            </a>
                        </li>
                    
                        <li class="nav-item">
                            <a class="nav-link top-level header-menu-links" href="http://github.com/ROCm/network-operator/issues/new/choose" id="navsupport" role="button" aria-expanded="false" target="_blank" >
                                Support
                            </a>
                        </li>
                    
                </ul>
            </div>
        </div>
    </nav>
    
</header>


  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">

<a class="navbar-brand logo" href="https://instinct.docs.amd.com">
    <p>Instinct Documentation</p>
</a></div>
          
        
      </div>
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">Network Operator</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-angle-right"></span>
  </label></div>
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Prometheus Integration with Metrics Exporter</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Prometheus Integration with Metrics Exporter</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#networkconfig-configuration">NetworkConfig Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-and-tls-options">Authentication and TLS Options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-metrics-with-prometheus">Accessing Metrics with Prometheus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-with-device-metrics-exporter-grafana-dashboards">Using with device-metrics-exporter Grafana Dashboards</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-pod-label-conflict">The <code class="docutils literal notranslate"><span class="pre">pod</span></code> Label Conflict</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-1-honorlabels-true-default">Solution 1: <code class="docutils literal notranslate"><span class="pre">honorLabels:</span> <span class="pre">true</span></code> (Default)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-2-relabeling">Solution 2: Relabeling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="prometheus-integration-with-metrics-exporter">
<h1>Prometheus Integration with Metrics Exporter<a class="headerlink" href="#prometheus-integration-with-metrics-exporter" title="Link to this heading">#</a></h1>
<p>The AMD Network Operator integrates with Prometheus to enable monitoring of Network metrics across the Kubernetes cluster. Metrics exposed by the Device Metrics Exporter can be automatically discovered and scraped by Prometheus through the creation of a ServiceMonitor resource.</p>
<p>Prometheus integration is managed via the <strong>ServiceMonitor</strong> configuration in the NetworkConfig Custom Resource (CR). When enabled, the operator automatically creates a ServiceMonitor tailored to the metrics exported by the Device Metrics Exporter. The integration supports various authentication and authorization methods, including Bearer Tokens and mutual TLS (mTLS), providing flexibility to accommodate different security requirements.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<p>Before enabling Prometheus integration, ensure you have:</p>
<ul class="simple">
<li><p>A running instance of the Prometheus Operator in your Kubernetes cluster.</p></li>
<li><p>The Device Metrics Exporter enabled in your Network Operator deployment.</p></li>
<li><p>Properly configured kube-rbac-proxy in the NetworkConfig CR if the exporter endpoint is protected (Optional).</p></li>
</ul>
<p>The AMD Network Operator relies on the ServiceMonitor CRD being available to inject the CRs when enabled. This CRD is installed by the Prometheus Operator.</p>
</section>
<section id="networkconfig-configuration">
<h2>NetworkConfig Configuration<a class="headerlink" href="#networkconfig-configuration" title="Link to this heading">#</a></h2>
<p>To integrate Prometheus, configure the following section in the NetworkConfig CR under <code class="docutils literal notranslate"><span class="pre">metricsExporter.prometheus.serviceMonitor</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">metricsExporter</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">prometheus</span><span class="p">:</span>
<span class="w">    </span><span class="nt">serviceMonitor</span><span class="p">:</span>
<span class="w">      </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;60s&quot;</span><span class="w"> </span><span class="c1"># Scrape frequency</span>
<span class="w">      </span><span class="nt">attachMetadata</span><span class="p">:</span>
<span class="w">        </span><span class="nt">node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">honorLabels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">      </span><span class="nt">honorTimestamps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">release</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-operator</span><span class="w"> </span><span class="c1"># Prometheus release label for target discovery</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>enable</strong>: Enable or disable Prometheus ServiceMonitor creation.</p></li>
<li><p><strong>interval</strong>: Frequency at which Prometheus scrapes metrics (e.g., “30s”, “1m”). Defaulted to the interval configured in Prometheus global scope.</p></li>
<li><p><strong>attachMetadata.node</strong>: Attaches node metadata to discovered targets.</p></li>
<li><p><strong>honorLabels</strong>: Retain scraped metric labels over the target labels if conflicts arise.</p></li>
<li><p><strong>honorTimestamps</strong>: Retain timestamps from scraped metrics.</p></li>
<li><p><strong>labels</strong>: Custom labels added to the ServiceMonitor to facilitate Prometheus discovery.</p></li>
</ul>
</section>
<section id="authentication-and-tls-options">
<h2>Authentication and TLS Options<a class="headerlink" href="#authentication-and-tls-options" title="Link to this heading">#</a></h2>
<p>The ServiceMonitor configuration supports various authentication and security methods for secure metrics collection:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">metricsExporter</span><span class="p">:</span>
<span class="w">    </span><span class="nt">prometheus</span><span class="p">:</span>
<span class="w">        </span><span class="nt">serviceMonitor</span><span class="p">:</span>
<span class="w">            </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">            </span><span class="nt">bearerTokenFile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;</span><span class="w"> </span><span class="c1"># Deprecated</span>
<span class="w">            </span><span class="nt">authorization</span><span class="p">:</span>
<span class="w">                </span><span class="nt">credentials</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metrics-token</span>
<span class="w">                    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">token</span>
<span class="w">            </span><span class="nt">tlsConfig</span><span class="p">:</span>
<span class="w">                </span><span class="nt">insecureSkipVerify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">                </span><span class="nt">serverName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metrics-server.example.com</span>
<span class="w">                </span><span class="nt">ca</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">configMap</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server-ca</span>
<span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class="w">                </span><span class="nt">cert</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">                        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-client-cert</span>
<span class="w">                        </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls.crt</span>
<span class="w">                </span><span class="nt">keySecret</span><span class="p">:</span>
<span class="w">                    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prometheus-client-cert</span>
<span class="w">                    </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tls.key</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>bearerTokenFile</strong>: (Deprecated) Path to a file containing the bearer token for authentication. Retained for legacy use case. Use authorization block instead to pass tokens.</p></li>
<li><p><strong>authorization</strong>: Configures token-based authorization. Reference to the token stored in a Kubernetes Secret</p></li>
<li><p><strong>tlsConfig</strong>: Configures TLS for secure connections:</p>
<ul>
<li><p><strong>insecureSkipVerify</strong>: When true, skips certificate verification (not recommended for production)</p></li>
<li><p><strong>serverName</strong>: Server name used for certificate validation</p></li>
<li><p><strong>ca</strong>: ConfigMap containing the CA certificate for server verification</p></li>
<li><p><strong>cert</strong>: Secret containing the client certificate for mTLS</p></li>
<li><p><strong>keySecret</strong>: Secret containing the client key for mTLS</p></li>
<li><p><strong>caFile/certFile/keyFile</strong>: File equivalents for certificates/keys mounted in Prometheus pod.</p></li>
</ul>
</li>
</ul>
<p>These options allow secure metrics collection from AMD Device Metrics Exporter endpoints that are protected by the kube-rbac-proxy sidecar for authentication/authorization.</p>
</section>
<section id="accessing-metrics-with-prometheus">
<h2>Accessing Metrics with Prometheus<a class="headerlink" href="#accessing-metrics-with-prometheus" title="Link to this heading">#</a></h2>
<p>Upon applying the NetworkConfig with the correct settings, the Network Operator automatically:</p>
<ul class="simple">
<li><p>Deploys the ServiceMonitor resource in the Network Operator namespace.</p></li>
<li><p>Sets the required labels and namespace selectors in ServiecMonitor CR for Prometheus discovery.</p></li>
</ul>
<p>After the <strong>ServiceMonitor</strong> is deployed, Prometheus automatically begins scraping metrics. Verify the integration by accessing the Prometheus UI and navigating to the “Targets” page. Your Device Metrics Exporter should appear as a healthy target. The ServiceMonitor object is deployed in the operator namespace and Prometheus must be configured to look for ServiceMonitor objects in this namespace. These two options in the Prometheus CR control ServiceMonitor discovery:</p>
<ul class="simple">
<li><p><strong>serviceAccountNamespaceSelector</strong>: Allows selecting namespaces to search for ServiceMonitor objects. An empty value selects all namespaces.</p></li>
<li><p><strong>serviceAccountSelector</strong>: Specifies which ServiceAccounts to select in the selected namesapace. The <code class="docutils literal notranslate"><span class="pre">labels</span></code> in NetworkConfig CR is added to the ServiceMonitor metadata and can be selected here.</p></li>
</ul>
<p>These selectors help Prometheus identify the correct ServiceMonitor to use in the AMD Network Operator namespace and begin metrics scraping.</p>
</section>
<section id="using-with-device-metrics-exporter-grafana-dashboards">
<h2>Using with device-metrics-exporter Grafana Dashboards<a class="headerlink" href="#using-with-device-metrics-exporter-grafana-dashboards" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/ROCm/device-metrics-exporter">ROCm/device-metrics-exporter</a> repository includes Grafana dashboards designed to visualize the exported metrics, particularly focusing on job-level or pod-level Network usage. These dashboards rely on specific labels exported by the metrics exporter, such as:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">pod</span></code>: The name of the workload Pod currently utilizing the AINIC.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">job_id</span></code>: An identifier for the job associated with the workload Pod.</p></li>
</ul>
<section id="the-pod-label-conflict">
<h3>The <code class="docutils literal notranslate"><span class="pre">pod</span></code> Label Conflict<a class="headerlink" href="#the-pod-label-conflict" title="Link to this heading">#</a></h3>
<p>When Prometheus scrapes targets defined by a <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code>, it automatically attaches labels to the metrics based on the target’s metadata. One such label is <code class="docutils literal notranslate"><span class="pre">pod</span></code>, which identifies the Pod being scraped (in this case, the metrics exporter Pod itself).</p>
<p>This creates a conflict:</p>
<ol class="arabic simple">
<li><p><strong>Exporter Metric Label:</strong> <code class="docutils literal notranslate"><span class="pre">pod=&quot;&lt;workload-pod-name&gt;&quot;</span></code> (Indicates the actual AINIC user)</p></li>
<li><p><strong>Prometheus Target Label:</strong> <code class="docutils literal notranslate"><span class="pre">pod=&quot;&lt;metrics-exporter-pod-name&gt;&quot;</span></code> (Indicates the source of the metric)</p></li>
</ol>
</section>
<section id="solution-1-honorlabels-true-default">
<h3>Solution 1: <code class="docutils literal notranslate"><span class="pre">honorLabels:</span> <span class="pre">true</span></code> (Default)<a class="headerlink" href="#solution-1-honorlabels-true-default" title="Link to this heading">#</a></h3>
<p>To ensure the Grafana dashboards function correctly by using the workload pod name, the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> created by the Network Operator needs to prioritize the labels coming directly from the metrics exporter over the labels added by Prometheus during the scrape.</p>
<p>This is achieved by setting <code class="docutils literal notranslate"><span class="pre">honorLabels:</span> <span class="pre">true</span></code> in the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> configuration within the <code class="docutils literal notranslate"><span class="pre">NetworkConfig</span></code>. <strong>This is the default setting in the Network Operator.</strong></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example NetworkConfig snippet</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">metricsExporter</span><span class="p">:</span>
<span class="w">    </span><span class="nt">prometheus</span><span class="p">:</span>
<span class="w">      </span><span class="nt">serviceMonitor</span><span class="p">:</span>
<span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="c1"># honorLabels defaults to true, ensuring exporter&#39;s &#39;pod&#39; label is kept</span>
<span class="w">        </span><span class="c1"># honorLabels: true </span>
<span class="w">        </span><span class="c1"># ... other ServiceMonitor settings</span>
</pre></div>
</div>
<p><strong>Important:</strong> For this to work, the <code class="docutils literal notranslate"><span class="pre">device-metrics-exporter</span></code> must actually be exporting the <code class="docutils literal notranslate"><span class="pre">pod</span></code> label, which typically only happens when a workload is actively using the AINIC on that node. If no workload is present, the <code class="docutils literal notranslate"><span class="pre">pod</span></code> label might be missing from the metric, and the dashboards might not display data as expected for that specific AINIC/node.</p>
</section>
<section id="solution-2-relabeling">
<h3>Solution 2: Relabeling<a class="headerlink" href="#solution-2-relabeling" title="Link to this heading">#</a></h3>
<p>An alternative approach is to use Prometheus relabeling rules within the <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> definition. This allows you to explicitly handle the conflicting <code class="docutils literal notranslate"><span class="pre">pod</span></code> label added by Prometheus.</p>
<p>You can rename the Prometheus-added <code class="docutils literal notranslate"><span class="pre">pod</span></code> label (identifying the exporter pod) to something else (e.g., <code class="docutils literal notranslate"><span class="pre">exporter_pod</span></code>) and then drop the original <code class="docutils literal notranslate"><span class="pre">pod</span></code> label added by Prometheus. This prevents the conflict and ensures the <code class="docutils literal notranslate"><span class="pre">pod</span></code> label from the exporter (identifying the workload) is the only one present on the final ingested metric.</p>
<p>Add the following <code class="docutils literal notranslate"><span class="pre">relabelings</span></code> to your <code class="docutils literal notranslate"><span class="pre">ServiceMonitor</span></code> configuration in the <code class="docutils literal notranslate"><span class="pre">NetworkConfig</span></code>:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example NetworkConfig snippet</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">metricsExporter</span><span class="p">:</span>
<span class="w">    </span><span class="nt">prometheus</span><span class="p">:</span>
<span class="w">      </span><span class="nt">serviceMonitor</span><span class="p">:</span>
<span class="w">        </span><span class="nt">enable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">        </span><span class="nt">honorLabels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># Must be false if using relabeling to preserve exporter_pod</span>
<span class="w">        </span><span class="nt">relabelings</span><span class="p">:</span>
<span class="w">          </span><span class="c1"># Rename the Prometheus-added &#39;pod&#39; label to &#39;exporter_pod&#39;</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">sourceLabels</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">pod</span><span class="p p-Indicator">]</span>
<span class="w">            </span><span class="nt">targetLabel</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">exporter_pod</span>
<span class="w">            </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replace</span>
<span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">(.*)</span>
<span class="w">            </span><span class="nt">replacement</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$1</span>
<span class="w">          </span><span class="c1"># Drop the Prometheus-added &#39;pod&#39; label to avoid conflict</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">action</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">labeldrop</span>
<span class="w">            </span><span class="nt">regex</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pod</span>
<span class="w">        </span><span class="c1"># ... other ServiceMonitor settings</span>
</pre></div>
</div>
<p>This method explicitly resolves the conflict by manipulating the labels before ingestion, ensuring the <code class="docutils literal notranslate"><span class="pre">pod</span></code> label always refers to the workload pod as intended by the <code class="docutils literal notranslate"><span class="pre">device-metrics-exporter</span></code>.</p>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">#</a></h2>
<p>The AMD Network Operator provides native support for Prometheus integration, simplifying Network monitoring and alerting within Kubernetes clusters. By configuring the NetworkConfig CR, you can manage Network metrics collection tailored to your requirements and preferences.
For more detailed configuration guidance, refer to the example scenarios <a class="reference external" href="https://github.com/rocm/network-operator/blob/main/example/">README</a>.</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#networkconfig-configuration">NetworkConfig Configuration</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication-and-tls-options">Authentication and TLS Options</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#accessing-metrics-with-prometheus">Accessing Metrics with Prometheus</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#using-with-device-metrics-exporter-grafana-dashboards">Using with device-metrics-exporter Grafana Dashboards</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-pod-label-conflict">The <code class="docutils literal notranslate"><span class="pre">pod</span></code> Label Conflict</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-1-honorlabels-true-default">Solution 1: <code class="docutils literal notranslate"><span class="pre">honorLabels:</span> <span class="pre">true</span></code> (Default)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#solution-2-relabeling">Solution 2: Relabeling</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusion">Conclusion</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <p>
  </p>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

<footer class="rocm-footer">
    <div class="container-lg">
        <section class="bottom-menu menu py-45">
            <div class="row d-flex align-items-center">
                <div class="col-12 text-center">
                    <ul>
                        <li><a href="https://www.amd.com/en/corporate/copyright" target="_blank">Terms and Conditions</a></li>
                        
                        <li><a href="https://www.amd.com/en/corporate/privacy" target="_blank">Privacy</a></li>
                        <li><a href="https://www.amd.com/en/corporate/trademarks" target="_blank">Trademarks</a></li>
                        <li><a href="https://www.amd.com/content/dam/amd/en/documents/corporate/cr/supply-chain-transparency.pdf" target="_blank">Supply Chain Transparency</a></li>
                        <li><a href="https://www.amd.com/en/corporate/competition" target="_blank">Fair and Open Competition</a></li>
                        <li><a href="https://www.amd.com/system/files/documents/amd-uk-tax-strategy.pdf" target="_blank">UK Tax Strategy</a></li>
                        <li><a href="https://www.amd.com/en/corporate/cookies" target="_blank">Cookie Policy</a></li>
                        <!-- OneTrust Cookies Settings button start -->
                        <li><a href="#cookie-settings" id="ot-sdk-btn" class="ot-sdk-show-settings">Cookie Settings</a></li>
                        <!-- OneTrust Cookies Settings button end -->
                    </ul>
                </div>
            </div>
            <div class="row d-flex align-items-center">
                <div class="col-12 text-center">
                    <div>
                        <span class="copyright">© 2025 Advanced Micro Devices, Inc</span>
                    </div>
                </div>
            </div>
        </section>
    </div>
</footer>

<!-- <div id="rdc-watermark-container">
    <img id="rdc-watermark" src="../_static/images/alpha-watermark.svg" alt="DRAFT watermark"/>
</div> -->
  </body>
</html>